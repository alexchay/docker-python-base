include:
  - project: '$GITLAB_CI_PATH'
    ref: '$GITLAB_CI_REF_NAME'
    file: '/ext/.build_docker_image.yml'

workflow:
  name: "Build $BUILD_IMAGE_NAME:$BUILD_IMAGE_TAG,$BUILD_IMAGE_TAGS"
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"

variables:
  DOCKER_BUILD_ARGS: >-
    --build-arg BASE_IMAGE_NAME --build-arg BASE_IMAGE_TAG
  CACHE_IMAGE: $CI_REGISTRY/$CI_REGISTRY_PATH/$BUILD_IMAGE_NAME:buildcache_$BUILD_IMAGE_TAG



build_image:
  stage: build
  extends:
    - .build_image


test_image:
  stage: test
  extends:
    - .test_image
  script:
    - pwd
    - ./scripts/test.sh
  variables:
    IMAGE_TAGS: $BUILD_IMAGE_TAG


tag_image:
  stage: release
  extends:
    - .tag_image


cleanup_build:
  stage: cleanup
  extends:
    - .cleanup_build

